<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login form</title>
    <link rel="stylesheet" href="./assets/styles/reset.css">
    <link rel="stylesheet" href="./assets/styles/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Gochi+Hand&family=Roboto:wght@100;300&display=swap"
        rel="stylesheet">
</head>

<body>
    <nav>
        <a href="#login">Login</a>
        <a href="#register">Register</a>
        <a href="#home">Home</a>
    </nav>

    <div class="page" id="login">

        <form id="loginForm">
            <input name="username" type="text" id="usernameInput" placeholder="Username" required>
            <input name="pass" type="password" id="passwordInput" placeholder="Password" required>
            <input type="submit" id="loginButton" value="Login">
            <span id="loginError"></span>
            <p>Don't have an account?<a href="#register" id="registerLink">Register</a></p>
        </form>

    </div>

    <div class="page" id="register">

        <form id="registerForm">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="pass" placeholder="Password" required>
            <input type="password" id="confirm-pass" placeholder="Confirm Password" required>
            <input type="submit" id="registerButton" value="Register">
            <span id="registerError"></span>
        </form>
    </div>

    <div class="page" id="home">
        <form id="loanForm">
            <input type="text" id="borrowerName" disabled>
            <label for="borrowerIncome">Enter your monthly income</label>
            <input type="number" name="borrowerIncome" id="borrowerIncome" placeholder="2000$" required>
            <label for="requestedAmount">How much money do you need?</label>
            <input type="number" name="requestedAmount" id="requestedAmount" value="1000" required>
            <label for="requestedTerm">Desired term</label>
            <input type="number" name="requestedTerm" id="requestedTerm" value="6" required>
            <input type="submit" id="submitLoan" value="Submit">
        </form>
    </div>
    <div class="page" id="applicationsOverview">
        <table>
            <tr>
                <th>id</th>
                <th>requested amount</th>
                <th>requested term</th>
                <th>status</th>
            </tr>
            <tr>
                <td id="loanId"></td>
                <td id="loanAmount"></td>
                <td id="loanTerm"></td>
                <td id="loanStatus"></td>
            </tr>
        </table>
        <button id="cancelBtn">Cancel</button>
        <button id="viewOffers">View offers</button>
        
        <table id="lendersOffers">
            <tr>
                <th>Interest Rate</th>
                <th>Loan Amount</th>
                <th>Monthly Payment</th>
                <th>Loan Term</th>
            </tr>
            <tr>
                <td id="interestRate"></td>
                <td id="loanAmountOffer"></td>
                <td id="monthlyPayment"></td>
                <td id="loanTermOffer"></td>
            </tr>
        </table>
        <button id="chooseOffer">Choose offer</button>
    </div>

    <footer>
        <p>Website created by: Tina Groshkova</p>
        <p>All rights reserved Â® 2023</p>
    </footer>
    <script src="./js/LoanManager.js"></script>
    <script src="./js/UserManager.js"></script>
    <script src="./js/ViewController.js"></script>
    <!-- <script>
        class Loan {
            constructor(name, montlyIncome, desiredAmount, desiredTerm) {
                this.name = name;
                this.montlyIncome = montlyIncome;
                this.desiredAmount = desiredAmount;
                this.desiredTerm = desiredTerm;
            }
        }
        class User {
            constructor(user, pass, loans) {
                this.username = user;
                this.pass = pass;
                this.loans = loans;
            }

            addLoan(loan) {
                this.loans.push(loan);
                localStorage.setItem(this.username, JSON.stringify(this.loans));
            }
        }

        class Admin extends User {
            constructor(name, password) {
                super(name, password);
                this.pendingLoans = [];
                this.approvedLoans = [];
                this.rejectedLoans = [];
            }

            approveLoan(loan) {
                if (this.pendingLoans.includes(loan)) {
                    this.pendingLoans.splice(this.pendingLoans.indexOf(loan), 1);
                    this.approvedLoans.push(loan);
                    console.log(`Loan with ID ${loan.id} has been approved.`);
                } else {
                    console.log(`Loan with ID ${loan.id} is not pending.`);
                }
            }

            rejectLoan(loan) {
                if (this.pendingLoans.includes(loan)) {
                    this.pendingLoans.splice(this.pendingLoans.indexOf(loan), 1);
                    this.rejectedLoans.push(loan);
                    console.log(`Loan with ID ${loan.id} has been rejected.`);
                } else {
                    console.log(`Loan with ID ${loan.id} is not pending.`);
                }
            }
        }


        class UserManager {
            constructor() {
                let loggedUser = JSON.parse(localStorage.getItem('isThereUser'));
                // let isAdmin = false;

                if (loggedUser) {
                    if (loggedUser.isAdmin) {
                        this.loggedUser = new Admin(loggedUser.username, loggedUser.pass);
                    } else {
                        this.loggedUser = new User(loggedUser.username, loggedUser.pass, this.loadLoans(loggedUser.username));
                    }
                }
                let allUsers = JSON.parse(localStorage.getItem('allUsers'));
                if (allUsers) {
                    this.users = allUsers.map(user => {
                        if (user.isAdmin) {
                            return new Admin(user.username, user.pass);
                        } else {
                            return new User(user.username, user.pass, this.loadLoans(user.username));
                        }
                    });

                } else {
                    this.users = [
                        new User('slavi', 'bahur', []),
                        new User('bahur', 'slavi', []),
                        new Admin('tina', 'T12345*')
                    ];
                    localStorage.setItem('allUsers', JSON.stringify(this.users));
                }
            }

            loggedUser = null;

            login = ({ username, pass }) => {
                let foundUser = this.users.find(user => user.username === username && user.pass === pass);

                if (foundUser) {
                    this.loggedUser = foundUser;
                    localStorage.setItem('isThereUser', JSON.stringify(this.loggedUser));
                    return true;
                }

                return false;
            }

            register = ({ username, pass }) => {
                let foundUser = this.users.find(user => user.username === username);

                if (foundUser) {
                    return false;
                }

                this.users.push(new User(username, pass, []));
                localStorage.setItem('allUsers', JSON.stringify(this.users));
                return true;
            }

            loadLoans = (username) => {
                let loans = JSON.parse(localStorage.getItem(username)) || [];
                return loans.map(loan => new Loan(loan.name, loan.montlyIncome, loan.desiredAmount, loan.desiredTerm));
            }
        }

        let userManager = new UserManager();
        class ViewController {

            constructor() {
                window.addEventListener("load", this.handleHashChange);
                window.addEventListener("hashchange", this.handleHashChange);
                this.id = 1;
            }

            handleHashChange = () => {
                const pageIds = ["login", "register", "home", "applicationsOverview"];

                let hash = location.hash.slice(1) || pageIds[0];

                if (hash === "home") {
                    if (!userManager.loggedUser) {
                        location.hash = "login";
                        return;
                    }
                    document.getElementById("loanForm").addEventListener("submit", this.handleLoanSubmission);
                    document.getElementById("borrowerName").value = userManager.loggedUser.username;
                }

                pageIds.forEach(pageId => {
                    let element = document.getElementById(pageId);
                    if (pageId === hash) {
                        element.style.display = "flex";
                    } else {
                        element.style.display = "none";
                    }
                });

                switch (hash) {
                    case "login":
                        this.renderLogin();
                        break;

                    case "register":
                        this.validateRegister();
                        this.renderRegister();
                        break;
                }
            }

            renderLogin = () => {
                let form = document.getElementById('loginForm');
                let usernameInput = document.getElementById('usernameInput');
                let passwordInput = document.getElementById('passwordInput');
                let errorMessage = document.getElementById('loginError');
                let loginButton = document.getElementById('loginButton');

                usernameInput.addEventListener('input', () => {
                    loginButton.disabled = !(usernameInput.value && passwordInput.value);
                });

                passwordInput.addEventListener('input', () => {
                    loginButton.disabled = !(usernameInput.value && passwordInput.value);
                });

                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                    let username = e.target.elements.username.value;
                    let pass = e.target.elements.pass.value;

                    if (this.validateLogin({ username, pass })) {
                        let successfulLogin = userManager.login({ username, pass });

                        if (!successfulLogin) {
                            errorMessage.innerText = "Wrong username or password!";
                            errorMessage.style.display = "block";

                        } else {
                            alert("Great! You are logged in now!");
                            location.hash = "home";
                            errorMessage.innerText = "";
                            console.log(userManager.loggedUser);

                            form.reset();
                        }
                    }
                });
                loginButton.disabled = !(usernameInput.value && passwordInput.value);
            }


            validateLogin = ({ username, pass }) => {
                if (!username || !pass) {
                    return false;
                }
                return true;
            }

            validateRegister = () => {
                let registerError = document.getElementById('registerError');
                let username = document.getElementById('username').value;
                let pass = document.getElementById('pass').value;
                let confirmPass = document.getElementById('confirm-pass').value;
                let registerButton = document.getElementById('registerButton');

                let passRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\W).{6,}$/;

                if (username && pass && confirmPass) {

                    if (pass === confirmPass) {
                        if (passRegex.test(pass)) {
                            registerButton.disabled = false;
                            registerError.innerText = "";
                            return true;

                        } else {
                            registerError.innerText = 'Password must be at least 6 characters long and contain at least one special character, one lowercase letter, and one uppercase letter.';
                        }

                    } else {
                        registerError.innerText = 'Password and confirm password do not match.';
                    }
                }

                registerError.style.display = 'block';
                registerButton.disabled = true;
                return false;
            }

            renderRegister = () => {
                let registerForm = document.getElementById("registerForm");
                let registerButton = document.getElementById('registerButton');
                let registerError = document.getElementById('registerError');

                registerButton.disabled = true;

                document.getElementById('username').addEventListener('input', () => {
                    this.validateRegister();
                });

                document.getElementById('pass').addEventListener('input', () => {
                    this.validateRegister();
                });

                document.getElementById('confirm-pass').addEventListener('input', () => {
                    this.validateRegister();
                });

                registerForm.addEventListener("submit", (e) => {
                    e.preventDefault();

                    if (this.validateRegister()) {
                        let username = document.getElementById('username').value;
                        let pass = document.getElementById('pass').value;
                        let registrationSuccessful = userManager.register({ username, pass });

                        if (registrationSuccessful) {
                            userManager.loggedUser = { username, pass };
                            location.hash = "home";
                        } else {
                            registerError.innerText = 'Username already taken';
                            registerError.style.display = 'block';
                        }
                    }
                    registerForm.reset();
                });
            }

            handleLoanSubmission = (event) => {
                let id = 1;
                event.preventDefault();
                let borrowerName = userManager.loggedUser.username;
                let cancelBtn = document.getElementById("cancelBtn");

                let borrowerIncome = document.getElementById("borrowerIncome");
                let requestedAmount = document.getElementById("requestedAmount");
                let requestedTerm = document.getElementById("requestedTerm");

                let loan = new Loan(borrowerName, borrowerIncome.value, requestedAmount.value, requestedTerm.value);

                let addLoanTimeout = setTimeout(() => {
                    if (!isLoanCanceled) {
                        userManager.loggedUser.addLoan(loan);
                        applicationsOverview.style.display = "none";
                        alert("Your credit request will be reviewed by an officer shortly");
                    }
                }, 6000);

                let isLoanCanceled = false;
                cancelBtn.addEventListener('click', () => {
                    isLoanCanceled = true;
                    clearTimeout(addLoanTimeout);
                    applicationsOverview.style.display = "none";
                });

                let loanId = document.getElementById("loanId");
                loanId.innerText = id;

                let loanAmount = document.getElementById("loanAmount");
                loanAmount.innerText = requestedAmount.value;

                let loanTerm = document.getElementById("loanTerm");
                loanTerm.innerText = requestedTerm.value;

                let status = document.getElementById("loanStatus");
                status.innerText = "Pending";

                alert("Loan submitted successfully!");

                borrowerIncome.value = borrowerIncome.defaultValue;
                requestedAmount.value = requestedAmount.defaultValue;
                requestedTerm.value = requestedTerm.defaultValue;

                location.hash = "applicationsOverview";
            }
        }

        let viewController = new ViewController(); -->
    </script>

</body>

</html>